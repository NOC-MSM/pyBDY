# pyBDY Documentation

**Welcome to the documentation for pyBDY (NEMO lateral boundary conditions)**

## Introduction

pyBDY is a python package to generate lateral boundary conditions for regional NEMO model configurations.
It has been developed to uses geographical and depth information from an a source data (e.g. a global ocean
simulation) and translate them to a destination NEMO region simulation. It makes use of a kdtree approximate
nearest neighbour algorithm in order to provide a generic method of weighted average interpolation for any
flavour of ocean model. The available options are accessed either through a NEMO style namelist or a
convient GUI.

---

## Contents

- [Dependencies :globe_with_meridians:](#dependencies-)
- [Quick Start Installation :rocket:](#quick-start-installation-)
- [How to use pyBDY :mechanical_arm:](#how-to-use-pybdy-)
- [Function List :scroll:](#function-list-)

## Dependencies :globe_with_meridians:

pyBDY is installed under a conda/mamba environment to aid wider distribution and to facilitate development.
The key dependecies are listed below:

- netCDF4
- scipy
- numpy
- matplotlib
- cartopy
- thredds_crawler
- seawater
- pyqt5
- pyjnius
- cftime

A recent JAVA installation is also required.

---

## Quick Start Installation :rocket:

To get started, check out and set up an instance of the pyBDY GitHub [repository](https://github.com/NOC-MSM/pyBDY):

```sh
export PYBDY_DIR=$PWD/pyBDY
git clone git@github.com:NOC-MSM/pyBDY.git
```

??? tip "Helpful Tip..."

    - **It is not advised to checkout the respository in your home directory.**

Creating a specific conda virtual environment is highly recommended ([click here for more about virtual
enviroments](https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html)).
Load conda (e.g. through anaconda/miniforge) and create the environment through the provided `environment.yml` file.

```sh
cd $PYBDY_DIR
conda env create -n pybdy -f environment.yml
```

Activate the new environment

```sh
conda activate pybdy
```

Install pyBDY

```sh
pip install -e .
```

Make sure the Java Runtime Environment is set:

```sh
export JAVA_HOME=path_to_jre
```

Generalised methods for defining paths are as follows:

```
export JAVA_HOME=$(readlink -f $(which java)) # UNIX
export JAVA_HOME=$(/usr/libexec/java_home)    # Mac
```

To check that pyBDY have been correctly installed in the virtual environment,
enter the following command:

```
pybdy -v
```

If it has you should see the help usage prompt:

```
usage: pybdy -g -s <namelist.bdy>
```

If not please see the troubleshooting pages for common causes as
to why the installation may fail.

To deactivate the conda environment:

```
conda deactivate
```

## How to use pyBDY :mechanical_arm:

In this documentation "bdy points" refer to the output boundary points generated by pyBDY.
Fist follow the installation instructions [Quick Start Installation](#quick-start-installation-).

### Step 1: File Preparation

Copy and paste the following files into your working directory:

- `inputs/namelist_local.bdy`

- `inputs/grid_name_map.json`

- `inputs/src_data_local.ncml`

- `namelist.bdy`: Specifies file paths and configuration options.

- `grid_name_map.json`: Defines variable names in horizontal and vertical grid files.

- `src_data.ncml`: Aggregates and remaps source data variables for PyBDY.

### Step 2: Edit the Namelist `namelist_local.bdy`

Descriptions of all required variables are in
[`src/pybdy/variable.info`](https://github.com/NOC-MSM/pyBDY/blob/master/src/pybdy/variable.info).
Here we will summarise the main variables that will need changing to get started.

#### Key Namelist Parameters

- `sn_src_hgr`
- `sn_src_zgr`
- `sn_dst_hgr`
- `sn_dst_zgr`
- `sn_src_msk`
- `sn_bathy`
- `sn_nme_map`
- `sn_src_dir`
- `sn_dst_dir`
- `cn_mask_file`
- `ln_zinterp`
- `nn_rimwidth`

##### File Paths

- **`sn_src_hgr`**: Source horizontal grid file. Should include:

    - Ideal: `glamt`, `gphit`, `glamu`, `e1t`, `e2t`, `e1u`, etc.
    - Minimum: `nav_lat`, `nav_lon` on a 2D grid.
    - Use `ncdump -h` or `ncview` to inspect variables.
    - Map extra variable names in `grid_name_map.json` to avoid recalculation.

- **`sn_src_zgr`**: Source vertical grid file. May be the same as `sn_src_hgr`.

    - Ideal: `gdept`, `e3t`, `mbathy` (aka `bottom_level`)
    - If `mbathy` is missing:
        - Use `gdept_0` (1D depth)
        - Use any 2D field (e.g., `nav_lon`) for `mbathy`
        - **Not recommended for destination**
    - Map variables like `gdepw`, `gdepu`, `e3w` in `grid_name_map.json`
    - **Note**: Time-varying depths are not used in PyBDY.

- **`sn_dst_hgr`, `sn_dst_zgr`**: Destination equivalents of the above.

- **`sn_src_msk`**: Source mask file with variables:

    - `tmask`, `umask`, `vmask`, `fmask`

- **`sn_bathy`**: Destination bathymetry file with variable:

    - `Bathymetry`

    - Used to calculate boundary mask if `ln_mask_file` is unset.

    - Can be computed from `e3w` and `bottom_level`:

        ```python
        gdepw = np.cumsum(e3w, axis=1)
        grid = np.indices(bottom_level.shape)
        bathy = gdepw[bottom_level, grid[0], grid[1]]
        ```

- **`sn_nme_map`**: Path to `grid_name_map.json`

    - **Note**: `ncml` is no longer used for grid input. Use `grid_name_map.json` instead. See [`inputs/grid_name_map_readme.txt`](https://github.com/NOC-MSM/pyBDY/blob/master/inputs/grid_name_map_readme.txt) for variable descriptions.

- **`sn_src_dir`**: Path to `src_data.ncml`

    - This is an xml file that points to source data (not grid) paths. It can also include THREDDS URLs (see `inputs/namelist_remote.bdy` for example).
    - See `inputs` folder for more examples.

    Example structure:

    ```xml
    <ns0:netcdf xmlns:ns0="http://www.unidata.ucar.edu/namespaces/netcdf/ncml-2.2" title="aggregation example">
      <ns0:aggregation type="union">
        <ns0:netcdf>
          <ns0:aggregation type="joinExisting" dimName="time_counter">
            <ns0:scan location="/path_to_src_data/Data/" regExp=".*grid_T.*" />
          </ns0:aggregation>
        </ns0:netcdf>
        <ns0:netcdf>
          <ns0:aggregation type="joinExisting" dimName="time_counter">
            <ns0:scan location="/path_to_src_data/Data/" regExp=".*grid_U.*" />
          </ns0:aggregation>
        </ns0:netcdf>
        <ns0:netcdf>
          <ns0:aggregation type="joinExisting" dimName="time_counter">
            <ns0:scan location="/path_to_src_data/Data/" regExp=".*grid_V.*" />
          </ns0:aggregation>
        </ns0:netcdf>
      </ns0:aggregation>
    </ns0:netcdf>
    ```

- **`sn_dst_dir`**: Output directory for PyBDY data

##### Other Settings

- **`cn_mask_file`** *(optional)*: Used to define open boundaries.

    - Values: `-1` (out-of-domain), `0` (land), `1` (water)
    - If not provided, PyBDY uses bathymetry to infer boundaries

- **`ln_zinterp`**: Disables vertical interpolation if `false` and source uses zco levels.

    - Output will match source vertical levels
    - If source uses zps or sco, this will be set to `true` automatically

- **`nn_rimwidth`**: Number of interior boundary points to generate

    - Typical value: `9`
    - For tidal boundaries: `1`

#### Time Settings

- Ensure `time_counter` exists in source files
- Files must be time-ascending
- NetCDF time metadata must include:
    - `calendar`: `"gregorian"`, `"noleap"`, or `"360_day"`
    - `units`: `"seconds since YYYY-MM-DD hh:mm:ss"`

##### Required Namelist Time Parameters

- **`sn_date_start`**: Start date for output (format: `YYYY-MM-DD`)
- **`sn_date_end`**: End date for output (format: `YYYY-MM-DD`)
    - The start date and end date of output must fall within the source data time range.
- **`sn_dst_calendar`**: Output calendar format
- **`sn_date_origin`**: Time counter reference date for output (format: `YYYY-MM-DD`)
- **`ln_time_interpolation`**: If `true`, interpolate to daily steps.
    - If `false`, output uses source data calendar (monthly steps only)

### Step 3: Running pyBDY

To use pyBDY, the following command is entered: (the example will run an benchmarking test):

```
pybdy -s /path/to/namelist/file (e.g. ./inputs/namelist_remote.bdy)
```

## Function List :scroll:
